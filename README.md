# 加密货币资金费率套利机器人

## 项目概述

这是一个专业的加密货币资金费率套利机器人，专注于利用不同交易所之间的资金费率差异进行套利交易。目前支持Hyperliquid和Backpack两个交易所，通过实时监控资金费率和价格差异，自动执行套利策略。

### 核心特点

- **多交易所支持**：同时连接Hyperliquid和Backpack交易所
- **实时监控**：持续监控资金费率和价格差异
- **智能套利**：基于预设条件自动执行套利交易
- **风险控制**：完善的仓位管理和风险控制机制
- **滑点控制**：智能分析订单深度，控制交易滑点
- **详细日志**：完整的交易记录和操作日志

## 系统架构

### 目录结构
```
funding_arbitrage_bot/
├── core/                    # 核心功能模块
│   ├── arbitrage_engine.py  # 套利引擎
│   ├── exchange.py         # 交易所接口
│   └── risk_manager.py     # 风险管理
├── utils/                   # 工具函数
│   ├── logger.py           # 日志工具
│   └── helpers.py          # 辅助函数
├── config.yaml             # 配置文件
└── main.py                 # 主程序入口
```

### 核心模块说明

1. **套利引擎 (arbitrage_engine.py)**
   - 实现套利策略逻辑
   - 管理交易执行
   - 处理开平仓条件
   - 计算套利机会

2. **交易所接口 (exchange.py)**
   - 封装交易所API
   - 处理订单管理
   - 获取市场数据
   - 执行交易操作

3. **风险管理 (risk_manager.py)**
   - 仓位控制
   - 风险限制
   - 资金管理
   - 止损策略

## 安装指南

### 环境要求
- Python 3.8+
- 操作系统：Windows/Linux/MacOS

### 安装步骤

1. **克隆仓库**
```bash
git clone https://github.com/yourusername/funding-arbitrage-bot.git
cd funding-arbitrage-bot
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **配置API密钥**
在`config.yaml`中配置交易所API密钥：
```yaml
exchanges:
  hyperliquid:
    api_key: "你的Hyperliquid钱包地址"
    api_secret: "你的Hyperliquid私钥"
  backpack:
    api_key: "你的Backpack API密钥"
    api_secret: "你的Backpack API密钥"
```

## 配置说明

### 基础配置
```yaml
strategy:
  # 基本参数
  min_funding_diff: 0.01    # 最小资金费率差异(1%)
  min_price_diff_pct: 0.001 # 最小价格差异(0.1%)
  
  # 交易参数
  trade_size_usd: 100      # 单笔交易金额(美元)
  max_position_usd: 500    # 最大仓位(美元)
  trade_cooldown: 3600     # 交易冷却时间(秒)
```

### 开仓条件
```yaml
open_conditions:
  condition_type: "funding_only"  # 条件类型
  min_funding_diff: 0.01         # 最小资金费率差异
  min_price_diff_percent: 0.2    # 最小价格差异
  max_slippage_percent: 0.15     # 最大允许滑点
  ignore_high_slippage: false    # 是否忽略高滑点
```

### 平仓条件
```yaml
close_conditions:
  condition_type: "any"          # 条件类型
  funding_diff_sign_change: true # 资金费率符号变化时平仓
  min_funding_diff: 0.005       # 最小资金费率差异
  min_profit_percent: 0.1       # 最小利润百分比
  max_loss_percent: 0.3         # 最大损失百分比
```

## 运行指南

### 启动程序
```bash
python run_bot.py
```

### 测试模式
```bash
python run_bot.py --test
```

### 指定配置文件
```bash
python run_bot.py --config path/to/config.yaml
```

## 风险控制

### 仓位管理
- 单个币种最大仓位限制
- 总体仓位限制
- 动态仓位调整

### 滑点控制
- 订单深度分析
- 滑点预估
- 动态滑点限制

### 止损机制
- 固定止损
- 追踪止损
- 时间止损

## 日志系统

### 日志级别
- DEBUG: 调试信息
- INFO: 一般信息
- WARNING: 警告信息
- ERROR: 错误信息

### 日志内容
- 交易执行记录
- 资金费率变化
- 套利机会分析
- 错误和异常信息

## 高级功能说明

### 方向一致性检查

方向一致性检查是一种确保套利交易在价差和资金费率两个方面都有利可图的机制。具体实现如下：

1. **工作原理**：
   - 基于开仓动机分析价格差异产生的交易方向（哪个交易所做多/做空）
   - 基于资金费率差异产生的交易方向（哪个交易所做多/做空）
   - 比较两种分析的结果，确保方向一致性

2. **配置方式**：
   ```yaml
   open_conditions:
     check_direction_consistency: true  # 启用方向一致性检查
   ```

3. **三种资金费率情况的处理**：
   - **两个交易所费率都为负**：绝对值大的交易所做多，小的做空
   - **两个交易所费率都为正**：值大的交易所做空，小的做多
   - **一正一负**：正费率交易所做空，负费率交易所做多

4. **实际应用场景**：
   - 当价格差异和资金费率差异指向相同交易方向时，套利风险更低
   - 防止因价格和资金费率冲突导致的套利亏损

5. **优化更新**：
   - 改进了方向一致性检查的逻辑，基于开仓动机而非简单的符号比较
   - 确保价格差异和资金费率差异产生的交易方向保持一致
   - 增强了套利稳定性，减少了理论上的矛盾情况
   - 通过日志记录详细的方向一致性检查过程，便于调试和验证

### 滑点计算优化

滑点计算是套利交易中至关重要的一环，我们通过分析订单深度来实现精确的滑点预估：

1. **滑点计算公式**：
   - 买单滑点 = (市场价 - 加权平均价) / 市场价 * 100%
   - 卖单滑点 = (加权平均价 - 市场价) / 市场价 * 100%

2. **订单深度分析**：
   - 分析订单簿前10层深度
   - 计算执行交易所需的加权平均价格
   - 考虑部分成交情况

3. **流动性不足处理**：
   - 当订单簿深度不足以满足交易金额时
   - 根据填充比例动态调整滑点估计
   - 填充率低于80%时采用特殊滑点计算公式

4. **配置项**：
   ```yaml
   open_conditions:
     max_slippage_percent: 0.15  # 开仓最大允许滑点
     ignore_high_slippage: false # 是否忽略高滑点

   close_conditions:
     max_close_slippage_percent: 0.25 # 平仓最大允许滑点
     ignore_close_slippage: false     # 是否忽略平仓滑点
   ```

5. **实际应用**：
   - 开仓前估计执行滑点，超过阈值则不开仓
   - 平仓时考虑滑点因素，防止高滑点导致盈利减少
   - 实时显示各币种当前预估滑点

### 持仓方向显示

最新版本的系统在终端显示界面中新增了两个列：
- **BP方向**：显示在Backpack交易所的持仓方向（多/空）
- **HL方向**：显示在Hyperliquid交易所的持仓方向（多/空）

这一功能可以帮助用户直观地看到两个交易所上的持仓状态，便于实时监控套利策略的执行情况。显示规则如下：
- "多"：表示在该交易所做多
- "空"：表示在该交易所做空
- "-"：表示在该交易所没有持仓

系统会实时更新这些信息，确保显示的持仓方向始终与实际账户状态保持一致。

### 进阶设置

## 常见问题

### 为什么我需要启用方向一致性检查？
方向一致性检查是确保套利交易安全性的关键机制。当价格差和资金费率差同时存在时，它确保两个交易所的交易方向相互一致，避免出现一边盈利一边亏损的风险。如果不启用此功能，系统可能会执行理论上存在矛盾的交易，长期来看可能导致亏损。

### 方向一致性检查可能会减少套利机会吗？
从理论上讲，方向一致性检查确实会筛选掉一些不符合一致性要求的套利机会。但这实际上是在保护您的资金安全，避免执行高风险的矛盾交易策略。我们的最新优化确保只有真正合理的套利机会才会被执行，同时最大化有效套利的数量。

### 资金费率差和价格差方向不一致时如何处理？
在最新版本中，系统会基于开仓动机而非简单的正负号比较来判断方向一致性：
1. 当价格差和资金费率差指向同一交易方向时，系统会执行交易
2. 当两者指向相反方向时，系统将评估综合收益并决定是否执行交易
3. 用户可以通过配置文件的`check_direction_consistency`参数控制此行为

### 如何判断我的套利策略是否正常运行？
可以通过以下方式判断：
1. 查看终端显示的BP方向和HL方向列，确认持仓方向是否符合预期
2. 检查日志文件中的方向一致性检查记录，了解系统决策过程
3. 观察账户余额随时间的变化，验证套利策略的有效性
4. 定期分析成交记录，确认套利操作的盈亏情况

### 如何最大化套利收益？
最大化套利收益需要：
1. 合理配置方向一致性检查，平衡安全性和机会捕捉
2. 调整滑点设置，确保订单能够成功成交
3. 优化资金费率计算周期，捕捉更多资金费率套利机会
4. 定期监控市场变化，调整参数适应不同市场环境

## 配置指南

### 方向一致性检查配置

在配置文件中，您可以通过以下参数控制方向一致性检查的行为：

```yaml
open_conditions:
  check_direction_consistency: true  # 启用方向一致性检查
  # 其他开仓条件...
  
close_conditions:
  check_direction_consistency: true  # 启用平仓方向一致性检查
  # 其他平仓条件...
```

#### 参数说明

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|-------|------|
| check_direction_consistency | 布尔值 | true | 是否启用方向一致性检查。设置为false时将不进行方向一致性检查，可能增加套利机会但也增加风险 |

#### 使用建议

1. **初学者**：建议保持方向一致性检查为启用状态，确保交易安全性
2. **进阶用户**：可以根据市场状况和个人风险承受能力调整此参数
3. **专业用户**：可以针对不同币种设置不同的方向一致性检查策略

### 资金费率配置

资金费率相关参数对套利策略至关重要：

```yaml
funding_rate:
  bp_funding_rate_weight: 1.0       # Backpack资金费率权重
  hl_funding_rate_weight: 1.0       # Hyperliquid资金费率权重
  funding_rate_threshold: 0.0001    # 资金费率阈值
  funding_multiplier: 3             # 资金费率放大倍数（Hyperliquid 1小时 -> 8小时）
```

此配置影响方向一致性检查的计算，对资金费率套利至关重要。

## 更新日志

### v1.3.0 (2024-08-10)
- **新增功能**：改进方向一致性检查逻辑，基于开仓动机而非简单差值符号
- **优化显示**：终端表格增加"BP方向"和"HL方向"列，实时显示各交易所持仓方向
- **文档更新**：增加配置指南和常见问题解答，帮助用户理解和配置方向一致性检查

### v1.2.0 (2024-07-15)
- 优化界面排序
- 改进滑点控制
- 增加资金费率符号变化检测

### 2025-04-08
- 添加新的平仓条件
- 优化风险管理
- 改进日志系统

## 贡献指南

欢迎提交Issue和Pull Request来帮助改进项目。在提交代码前，请确保：
1. 代码符合PEP 8规范
2. 添加适当的测试
3. 更新相关文档

## 许可证

本项目采用MIT许可证。详见LICENSE文件。

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交Issue
- 发送邮件至：your.email@example.com 